package base

import (
	"fmt"
	"strings"
)

var sqlKeywords = map[string]struct{}{
	"ABORT":             {},
	"ABSOLUTE":          {},
	"ACCESS":            {},
	"ACTION":            {},
	"ADD":               {},
	"ADMIN":             {},
	"AFTER":             {},
	"AGGREGATE":         {},
	"ALL":               {},
	"ALTER":             {},
	"ANALYSE":           {},
	"ANALYZE":           {},
	"AND":               {},
	"ANTI":              {},
	"ANY":               {},
	"AS":                {},
	"ASOF":              {},
	"ASC":               {},
	"ASSERTION":         {},
	"ASSIGNMENT":        {},
	"ASYMMETRIC":        {},
	"AT":                {},
	"AUTHORIZATION":     {},
	"BACKWARD":          {},
	"BEFORE":            {},
	"BEGIN":             {},
	"BETWEEN":           {},
	"BINARY":            {},
	"BOTH":              {},
	"BY":                {},
	"CACHE":             {},
	"CALL":              {},
	"CALLED":            {},
	"CASCADE":           {},
	"CASCADED":          {},
	"CASE":              {},
	"CAST":              {},
	"CATALOG":           {},
	"CHAIN":             {},
	"CHARACTERISTICS":   {},
	"CHECK":             {},
	"CHECKPOINT":        {},
	"CLASS":             {},
	"CLOSE":             {},
	"CLUSTER":           {},
	"COALESCE":          {},
	"COLLATE":           {},
	"COLLATION":         {},
	"COLUMN":            {},
	"COMMENT":           {},
	"COMMENTS":          {},
	"COMMIT":            {},
	"COMMITTED":         {},
	"CONCURRENTLY":      {},
	"CONFIGURATION":     {},
	"CONFLICT":          {},
	"CONNECTION":        {},
	"CONSTRAINT":        {},
	"CONSTRAINTS":       {},
	"CONTENT":           {},
	"CONTINUE":          {},
	"CONVERSION":        {},
	"COPY":              {},
	"COST":              {},
	"CREATE":            {},
	"CROSS":             {},
	"CSV":               {},
	"CUBE":              {},
	"CURRENT":           {},
	"CURRENT_CATALOG":   {},
	"CURRENT_DATE":      {},
	"CURRENT_ROLE":      {},
	"CURRENT_SCHEMA":    {},
	"CURRENT_TIME":      {},
	"CURRENT_TIMESTAMP": {},
	"CURRENT_USER":      {},
	"CURSOR":            {},
	"CYCLE":             {},
	"DATA":              {},
	"DATABASE":          {},
	"DAY":               {},
	"DEALLOCATE":        {},
	"DEC":               {},
	"DECLARE":           {},
	"DEFAULT":           {},
	"DEFAULTS":          {},
	"DEFERRABLE":        {},
	"DEFERRED":          {},
	"DEFINER":           {},
	"DELETE":            {},
	"DELIMITER":         {},
	"DELIMITERS":        {},
	"DEPENDS":           {},
	"DESC":              {},
	"DETACH":            {},
	"DICTIONARY":        {},
	"DISABLE":           {},
	"DISCARD":           {},
	"DISTINCT":          {},
	"DO":                {},
	"DOCUMENT":          {},
	"DOMAIN":            {},
	"DOUBLE":            {},
	"DROP":              {},
	"EACH":              {},
	"ELSE":              {},
	"ENABLE":            {},
	"ENCODING":          {},
	"ENCRYPTED":         {},
	"END":               {},
	"ESCAPE":            {},
	"EVENT":             {},
	"EXCEPT":            {},
	"EXCLUDE":           {},
	"EXCLUDING":         {},
	"EXCLUSIVE":         {},
	"EXECUTE":           {},
	"EXISTS":            {},
	"EXPLAIN":           {},
	"EXTENSION":         {},
	"EXTERNAL":          {},
	"EXTRACT":           {},
	"FALSE":             {},
	"FETCH":             {},
	"FILTER":            {},
	"FIRST":             {},
	"FOLLOWING":         {},
	"FOR":               {},
	"FORCE":             {},
	"FOREIGN":           {},
	"FORWARD":           {},
	"FREEZE":            {},
	"FROM":              {},
	"FULL":              {},
	"FUNCTION":          {},
	"FUNCTIONS":         {},
	"GLOBAL":            {},
	"GRANT":             {},
	"GRANTED":           {},
	"GREATEST":          {},
	"GROUP":             {},
	"GROUPING":          {},
	"HANDLER":           {},
	"HAVING":            {},
	"HEADER":            {},
	"HOLD":              {},
	"HOUR":              {},
	"IDENTITY":          {},
	"IF":                {},
	"ILIKE":             {},
	"IMMEDIATE":         {},
	"IMMUTABLE":         {},
	"IMPLICIT":          {},
	"IN":                {},
	"INCLUDING":         {},
	"INCREMENT":         {},
	"INDEX":             {},
	"INDEXES":           {},
	"INHERIT":           {},
	"INHERITS":          {},
	"INITIALLY":         {},
	"INNER":             {},
	"INOUT":             {},
	"INPUT":             {},
	"INSENSITIVE":       {},
	"INSERT":            {},
	"INSTEAD":           {},
	"INTERSECT":         {},
	"INTO":              {},
	"INVOKER":           {},
	"IS":                {},
	"ISNULL":            {},
	"ISOLATION":         {},
	"JOIN":              {},
	"KEY":               {},
	"LABEL":             {},
	"LANGUAGE":          {},
	"LARGE":             {},
	"LAST":              {},
	"LATERAL":           {},
	"LEADING":           {},
	"LEAKPROOF":         {},
	"LEAST":             {},
	"LEFT":              {},
	"LEVEL":             {},
	"LIKE":              {},
	"LIMIT":             {},
	"LISTEN":            {},
	"LOAD":              {},
	"LOCAL":             {},
	"LOCALTIME":         {},
	"LOCALTIMESTAMP":    {},
	"LOCATION":          {},
	"LOCK":              {},
	"LOCKED":            {},
	"LOGGED":            {},
	"MAPPING":           {},
	"MATCH":             {},
	"MATERIALIZED":      {},
	"MAXVALUE":          {},
	"METHOD":            {},
	"MINUTE":            {},
	"MINVALUE":          {},
	"MODE":              {},
	"MONTH":             {},
	"MOVE":              {},
	"NAME":              {},
	"NAMES":             {},
	"NATIONAL":          {},
	"NATURAL":           {},
	"NCHAR":             {},
	"NEW":               {},
	"NEXT":              {},
	"NO":                {},
	"NONE":              {},
	"NOT":               {},
	"NOTHING":           {},
	"NOTIFY":            {},
	"NOTNULL":           {},
	"NOWAIT":            {},
	"NULL":              {},
	"NULLIF":            {},
	"NULLS":             {},
	"OBJECT":            {},
	"OF":                {},
	"OFF":               {},
	"OFFSET":            {},
	"OIDS":              {},
	"OLD":               {},
	"ON":                {},
	"ONLY":              {},
	"OPERATOR":          {},
	"OPTION":            {},
	"OPTIONS":           {},
	"OR":                {},
	"ORDER":             {},
	"ORDINALITY":        {},
	"OUT":               {},
	"OUTER":             {},
	"OVER":              {},
	"OVERLAPS":          {},
	"OVERLAY":           {},
	"OVERRIDING":        {},
	"OWNED":             {},
	"OWNER":             {},
	"PARALLEL":          {},
	"PARSER":            {},
	"PARTIAL":           {},
	"PARTITION":         {},
	"PASSING":           {},
	"PASSWORD":          {},
	"PLACING":           {},
	"PLANS":             {},
	"POLICY":            {},
	"POSITION":          {},
	"POSITIONAL":        {},
	"PRECEDING":         {},
	"PRECISION":         {},
	"PREPARE":           {},
	"PREPARED":          {},
	"PRESERVE":          {},
	"PRIMARY":           {},
	"PRIOR":             {},
	"PRIVILEGES":        {},
	"PROCEDURAL":        {},
	"PROCEDURE":         {},
	"PROGRAM":           {},
	"PUBLICATION":       {},
	"QUOTE":             {},
	"RANGE":             {},
	"READ":              {},
	"REASSIGN":          {},
	"RECHECK":           {},
	"RECURSIVE":         {},
	"REF":               {},
	"REFERENCES":        {},
	"REFRESH":           {},
	"REINDEX":           {},
	"RELATIVE":          {},
	"RELEASE":           {},
	"RENAME":            {},
	"REPEATABLE":        {},
	"REPLACE":           {},
	"REPLICA":           {},
	"RESET":             {},
	"RESTART":           {},
	"RESTRICT":          {},
	"RETURNING":         {},
	"RETURNS":           {},
	"REVOKE":            {},
	"RIGHT":             {},
	"ROLE":              {},
	"ROLLBACK":          {},
	"ROLLUP":            {},
	"ROUTINE":           {},
	"ROUTINES":          {},
	"ROW":               {},
	"ROWS":              {},
	"RULE":              {},
	"SAVEPOINT":         {},
	"SCHEMA":            {},
	"SCHEMAS":           {},
	"SCROLL":            {},
	"SEARCH":            {},
	"SECOND":            {},
	"SECURITY":          {},
	"SELECT":            {},
	"SEMI":              {},
	"SEQUENCE":          {},
	"SEQUENCES":         {},
	"SERIALIZABLE":      {},
	"SERVER":            {},
	"SESSION":           {},
	"SESSION_USER":      {},
	"SET":               {},
	"SETOF":             {},
	"SETS":              {},
	"SHARE":             {},
	"SHOW":              {},
	"SIMILAR":           {},
	"SIMPLE":            {},
	"SKIP":              {},
	"SNAPSHOT":          {},
	"SOME":              {},
	"SQL":               {},
	"STABLE":            {},
	"STANDALONE":        {},
	"START":             {},
	"STATEMENT":         {},
	"STATISTICS":        {},
	"STDIN":             {},
	"STDOUT":            {},
	"STORAGE":           {},
	"STRICT":            {},
	"STRIP":             {},
	"SUBSCRIPTION":      {},
	"SUBSTRING":         {},
	"SYMMETRIC":         {},
	"SYSID":             {},
	"SYSTEM":            {},
	"TABLE":             {},
	"TABLES":            {},
	"TABLESAMPLE":       {},
	"TABLESPACE":        {},
	"TEMP":              {},
	"TEMPLATE":          {},
	"TEMPORARY":         {},
	"THEN":              {},
	"TO":                {},
	"TRAILING":          {},
	"TRANSACTION":       {},
	"TRANSFORM":         {},
	"TREAT":             {},
	"TRIGGER":           {},
	"TRIM":              {},
	"TRUE":              {},
	"TRUNCATE":          {},
	"TRUSTED":           {},
	"TYPE":              {},
	"TYPES":             {},
	"UNBOUNDED":         {},
	"UNCOMMITTED":       {},
	"UNENCRYPTED":       {},
	"UNION":             {},
	"UNIQUE":            {},
	"UNKNOWN":           {},
	"UNLISTEN":          {},
	"UNLOGGED":          {},
	"UNTIL":             {},
	"UPDATE":            {},
	"USER":              {},
	"USING":             {},
	"VACUUM":            {},
	"VALID":             {},
	"VALIDATE":          {},
	"VALIDATOR":         {},
	"VALUE":             {},
	"VALUES":            {},
	"VARIADIC":          {},
	"VARYING":           {},
	"VERBOSE":           {},
	"VERSION":           {},
	"VIEW":              {},
	"VIEWS":             {},
	"VOLATILE":          {},
	"WHEN":              {},
	"WHERE":             {},
	"WHITESPACE":        {},
	"WINDOW":            {},
	"WITH":              {},
	"WITHOUT":           {},
	"WORK":              {},
	"WRAPPER":           {},
	"WRITE":             {},
	"XMLATTRIBUTES":     {},
	"XMLCONCAT":         {},
	"XMLELEMENT":        {},
	"XMLEXISTS":         {},
	"XMLFOREST":         {},
	"XMLNAMESPACES":     {},
	"XMLPARSE":          {},
	"XMLPI":             {},
	"XMLROOT":           {},
	"XMLSERIALIZE":      {},
	"YEAR":              {},
	"YES":               {},
	"ZONE":              {},

	// Data types
	"SMALLINT":                    {},
	"INTEGER":                     {},
	"INT":                         {},
	"BIGINT":                      {},
	"DECIMAL":                     {},
	"NUMERIC":                     {},
	"REAL":                        {},
	"DOUBLE PRECISION":            {},
	"FLOAT":                       {},
	"SMALLSERIAL":                 {},
	"SERIAL":                      {},
	"BIGSERIAL":                   {},
	"MONEY":                       {},
	"CHARACTER VARYING":           {},
	"VARCHAR":                     {},
	"CHARACTER":                   {},
	"CHAR":                        {},
	"TEXT":                        {},
	"STRING":                      {},
	"BYTEA":                       {},
	"TIMESTAMP":                   {},
	"TIMESTAMP WITH TIME ZONE":    {},
	"TIMESTAMP WITHOUT TIME ZONE": {},
	"DATE":                        {},
	"TIME":                        {},
	"TIME WITH TIME ZONE":         {},
	"TIME WITHOUT TIME ZONE":      {},
	"INTERVAL":                    {},
	"BOOLEAN":                     {},
	"BOOL":                        {},
	"POINT":                       {},
	"LINE":                        {},
	"LSEG":                        {},
	"BOX":                         {},
	"PATH":                        {},
	"POLYGON":                     {},
	"CIRCLE":                      {},
	"CIDR":                        {},
	"INET":                        {},
	"MACADDR":                     {},
	"MACADDR8":                    {},
	"BIT":                         {},
	"BIT VARYING":                 {},
	"TSVECTOR":                    {},
	"TSQUERY":                     {},
	"UUID":                        {},
	"XML":                         {},
	"JSON":                        {},
	"JSONB":                       {},
	"INT4RANGE":                   {},
	"INT8RANGE":                   {},
	"NUMRANGE":                    {},
	"TSRANGE":                     {},
	"TSTZRANGE":                   {},
	"DATERANGE":                   {},
	"ARRAY":                       {},
	"COMPOSITE":                   {},
	"ENUM":                        {},
	"LIST":                        {},
	"STRUCT":                      {},
	"MAP":                         {},
	"BITSTRING":                   {},
	"BLOB":                        {},
	"TINYINT":                     {},
	"HUGEINT":                     {},
	"UTINYINT":                    {},
	"USMALLINT":                   {},
	"UINTEGER":                    {},
	"UBIGINT":                     {},
	"UHUGEINT":                    {},
	"FLOAT8":                      {},
	"FLOAT4":                      {},
	"TIMETZ":                      {},
	"*":                           {},
	"GEOMETRY":                    {},
	"GEOGRAPHY":                   {},
}

func Ident(s string) string {
	if !IsValidIdentifier(s) {
		return fmt.Sprintf(`"%s"`, s)
	}
	return s
}

// Функция для проверки идентификатора
func IsValidIdentifier(s string) bool {
	upperStr := strings.ToUpper(s)
	_, isKeyword := sqlKeywords[upperStr]
	if isKeyword {
		return false
	}
	// Проверка валидности идентификатора
	if len(s) == 0 {
		return false
	}
	firstChar := s[0]
	if !isLetter(firstChar) && firstChar != '_' {
		return false
	}
	for i := 1; i < len(s); i++ {
		if !isLetter(s[i]) && !isDigit(s[i]) && s[i] != '_' {
			return false
		}
	}
	return true
}

func isLetter(c byte) bool {
	return (c >= 'A' && c <= 'Z') || (c >= 'a' && c <= 'z')
}

func isDigit(c byte) bool {
	return c >= '0' && c <= '9'
}
